---
description: Guidelines for using @convex-dev/self-static-hosting to self-host static React/Vite apps on Convex
globs: **/convex/**/*.ts,**/convex/**/*.tsx,**/src/**/*.ts,**/src/**/*.tsx
alwaysApply: false
---

# Convex Self Static Hosting

## Package info

- Package: `@convex-dev/self-static-hosting`
- Install: `npm install @convex-dev/self-static-hosting@alpha`
- Current version: `0.1.2-alpha.1`
- GitHub: https://github.com/get-convex/self-static-hosting
- License: Apache-2.0
- Peer deps: `convex ^1.29.3`, `react ^18.3.1 || ^19.0.0`

## What it does

A Convex component that self-hosts static React/Vite apps using Convex HTTP actions and file storage. No Vercel, Netlify, or external hosting required.

Build phase: bundler creates `dist/`. Upload phase: CLI uploads files to Convex storage with metadata. Serve phase: HTTP actions serve files with correct Content-Type, smart cache control, SPA fallback.

## Deployment modes

| Mode | Storage | CDN | Best For | Complexity |
|------|---------|-----|----------|------------|
| Cloudflare Pages | Cloudflare Edge | Built-in | Production apps | Medium |
| Convex Storage | Convex | None | Simple apps, dev/testing | Low |
| Convex + CF CDN | Convex | Cloudflare | Custom domain + caching | High |

Note: v0.1.2-alpha.1 removed Cloudflare support temporarily. Convex Storage mode is the primary mode.

## Required files

### 1. convex/convex.config.ts

```typescript
import { defineApp } from "convex/server";
import selfStaticHosting from "@convex-dev/self-static-hosting/convex.config.js";

const app = defineApp();
app.use(selfStaticHosting);

export default app;
```

### 2. convex/staticHosting.ts

```typescript
import { components } from "./_generated/api";
import {
  exposeUploadApi,
  exposeDeploymentQuery,
} from "@convex-dev/self-static-hosting";

// Internal functions for secure uploads (CLI only, not public)
export const { generateUploadUrl, recordAsset, gcOldAssets, listAssets } =
  exposeUploadApi(components.selfStaticHosting);

// Public query for live reload notifications
export const { getCurrentDeployment } =
  exposeDeploymentQuery(components.selfStaticHosting);
```

### 3. convex/http.ts (Convex Storage mode only)

```typescript
import { httpRouter } from "convex/server";
import { registerStaticRoutes } from "@convex-dev/self-static-hosting";
import { components } from "./_generated/api";

const http = httpRouter();

registerStaticRoutes(http, components.selfStaticHosting);

export default http;
```

With path prefix (recommended when you also have API routes):

```typescript
registerStaticRoutes(http, components.selfStaticHosting, {
  pathPrefix: "/app",
  spaFallback: true,
});
```

### 4. package.json scripts

```json
{
  "scripts": {
    "deploy": "npx @convex-dev/self-static-hosting deploy",
    "deploy:static": "npx @convex-dev/self-static-hosting upload --build --prod"
  }
}
```

## CLI commands

```bash
# Interactive setup wizard (creates all files)
npx @convex-dev/self-static-hosting setup

# One-shot deploy (build + backend + static)
npx @convex-dev/self-static-hosting deploy

# Upload static files only
npx @convex-dev/self-static-hosting upload --build --prod

# Upload options
npx @convex-dev/self-static-hosting upload [options]
  -d, --dist <path>        Path to dist directory (default: ./dist)
  -c, --component <name>   Convex component name (default: staticHosting)
      --prod               Deploy to production
      --dev                Deploy to dev (default)
  -b, --build              Run build with correct VITE_CONVEX_URL
      --domain <name>      Custom domain + CF cache purge
```

## Critical rules

- ALWAYS use `--build` flag when deploying. Running `npm run build` separately uses the dev URL from `.env.local`.
- Run `npx convex dev` at least once after setup to push schema and enable HTTP actions.
- Upload functions are INTERNAL only. Not publicly accessible. Only callable via `npx convex run` or other Convex server-side functions.
- The component manages its own `staticAssets` table with `by_path` and `by_deploymentId` indexes.

## Schema (managed by component)

The component creates a `staticAssets` table internally:

```typescript
defineTable({
  path: v.string(),
  storageId: v.id("_storage"),
  contentType: v.string(),
  deploymentId: v.string(),
})
  .index("by_path", ["path"])
  .index("by_deploymentId", ["deploymentId"])
```

## Cache behavior

| File Type | Cache-Control | ETag | Behavior |
|-----------|--------------|------|----------|
| *.js, *.css (hashed) | max-age=1yr, immutable | Yes | Cached forever, new hash = new URL |
| index.html | must-revalidate | Yes | Revalidates with 304 support |
| Images, fonts | max-age=1yr, immutable | Yes | Cached long-term |

## SPA fallback

Requests without a file extension that 404 automatically fall back to `/index.html`. Paths like `/assets/missing.js` correctly return 404.

## Client-side URL detection

When self-hosted on `.convex.site`, derive the API URL:

```typescript
import { getConvexUrl } from "@convex-dev/self-static-hosting";

const convexUrl = import.meta.env.VITE_CONVEX_URL ?? getConvexUrl();
```

The `getConvexUrl()` function converts `.convex.site` to `.convex.cloud`.

## Live reload

```typescript
// In App.tsx
import { UpdateBanner } from "@convex-dev/self-static-hosting/react";
import { api } from "../convex/_generated/api";

function App() {
  return (
    <div>
      <UpdateBanner
        getCurrentDeployment={api.staticHosting.getCurrentDeployment}
        message="New version available!"
        buttonText="Refresh"
      />
      {/* rest of app */}
    </div>
  );
}
```

Or the hook:

```typescript
import { useDeploymentUpdates } from "@convex-dev/self-static-hosting/react";

const { updateAvailable, reload, dismiss } = useDeploymentUpdates(
  api.staticHosting.getCurrentDeployment,
);
```

## Non-Vite bundlers

The CLI sets `VITE_CONVEX_URL`. For other bundlers, pass it through:

Expo:
```json
{ "build": "EXPO_PUBLIC_CONVEX_URL=${VITE_CONVEX_URL:-$EXPO_PUBLIC_CONVEX_URL} npx expo export --platform web" }
```

Next.js:
```json
{ "build": "NEXT_PUBLIC_CONVEX_URL=${VITE_CONVEX_URL:-$NEXT_PUBLIC_CONVEX_URL} next build" }
```

## API surface

- `registerStaticRoutes(http, component, options?)` registers HTTP routes for serving static files
- `exposeUploadApi(component)` returns `{ generateUploadUrl, recordAsset, gcOldAssets, listAssets }`
- `exposeDeploymentQuery(component)` returns `{ getCurrentDeployment }`
- `getConvexUrl()` derives Convex API URL from `.convex.site` hostname

## Vite config: module deduplication

When importing from shared modules, deduplicate React and Convex:

```typescript
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import path from "path";

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      react: path.resolve(__dirname, "./node_modules/react"),
      "react-dom": path.resolve(__dirname, "./node_modules/react-dom"),
      "convex/react": path.resolve(__dirname, "./node_modules/convex/react"),
    },
  },
});
```

Without this you get: `Cannot read properties of null (reading 'useRef')` or `Could not find Convex client!`
